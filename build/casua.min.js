(function(){var casua,k,v,__boolean_attr_regexp,__mutiple_levels_key_regexp,_escapeHTML,_escape_chars,_reversed_escape_chars,_scopeCallAltWatch,_scopeCallWatch,_scopeChangeLength,_scopeInitParent,_scopeRemovePrepare,_shallowCopy,__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};_shallowCopy=function(e,t){var n,r;null==t&&(t={});for(n in e)r=e[n],t[n]=r;return t},_escape_chars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"},_reversed_escape_chars={};for(k in _escape_chars)v=_escape_chars[k],_reversed_escape_chars[v]=k;_escapeHTML=function(e){return e.replace(/[&<>"']/g,function(e){return"&"+_reversed_escape_chars[e]+";"})},__boolean_attr_regexp=/^multiple|selected|checked|disabled|required|open$/,casua={},casua.Node=function(){function e(e){var t,n,o,a,c,s,i,_,u,h,l,p;if(this.handlers={},this.events={},this.length=0,e instanceof casua.Node)return e;if("string"==typeof e)if("<"!==e.charAt(0))for(n=e.split(" "),i=n.shift(),c=document.createElement((s=i.match(/^([^\.^#]+)/))?s[1]:"div"),(s=i.match(/\.([^\.^#]+)/g))&&(c.className=s.join(" ").replace(/\./g,"")),(s=i.match(/#([^\.^#]+)/))&&(c.id=s[1]),r(this,c),_=0,h=n.length;h>_;_++)t=n[_],"#"!==t.charAt(0)&&(s=t.match(/^([^=]+)(?:=(['"])(.+?)\2)?$/))&&this.attr(s[1],s[3]||s[1]);else for(a=document.createElement("div"),a.innerHTML="<div>&#160;</div>"+e,a.removeChild(a.firstChild),p=a.childNodes,u=0,l=p.length;l>u;u++)o=p[u],r(this,o);else e.nodeName&&r(this,e)}var t,n,r,o,a;return r=function(e,t){var n,r,o,c;for(t.nodeName&&(t=[t]),c=[],r=0,o=t.length;o>r;r++)n=t[r],c.push(a(e,n));return c},a=function(e,t){return e[e.length]=t,e.length+=1},o=function(e,t){var n,r,o;return o=function(){var o,a,c;for(c=[],n=o=0,a=e.length;a>o;n=++o)r=e[n],c.push(t.call(r,n,r));return c}(),o[0]},t=window.document.addEventListener?function(e,t,n){return e.addEventListener(t,n,!1)}:function(e,t,n){return e.attachEvent("on"+t,n)},n=function(e,t){var n;return n=function(n,r){var o,a,c,s;n.preventDefault||(n.preventDefault=function(){return n.returnValue=!1}),n.stopPropagation||(n.stopPropagation=function(){return n.cancelBubble=!0}),n.target||(n.target=n.srcElement||document),null==n.defaultPrevented&&(s=n.preventDefault,n.preventDefault=function(){return n.defaultPrevented=!0,s.call(n)},n.defaultPrevented=!1),n.isDefaultPrevented=function(){return n.defaultPrevented||n.returnValue===!1},o=_shallowCopy(t[r||n.type]||[]);for(c in o)a=o[c],a.call(e,n);return delete n.preventDefault,delete n.stopPropagation,delete n.isDefaultPrevented},n.elem=e,n.handleds=[],n},e.prototype.attr=function(e,t){return e=e.toLowerCase(),e.match(/^val|value$/)?this.val(t):e.match(__boolean_attr_regexp)?null!=t?t?o(this,function(){return this.setAttribute(e,e),this[e]=!0}):o(this,function(){return this.removeAttribute(e),this[e]=!1}):this[0][e]:null!=t?(o(this,function(){return this.setAttribute(e,t)}),this):this[0].getAttribute(e,2)},e.prototype.append=function(e){return"string"==typeof e&&(e=new casua.Node(e)),o(this,function(t,n){return o(e,function(e,t){return n.appendChild(t)})}),this},e.prototype.empty=function(){return o(this,function(){var e;for(e=[];this.firstChild;)e.push(this.removeChild(this.firstChild));return e}),this},e.prototype.html=function(e){return null!=e?(this.empty(),o(this,function(){return this.innerHTML=e}),this):this[0].innerHTML},e.prototype.text=function(e){return null!=e?this.html(_escapeHTML(e)):this.html()},e.prototype.on=function(e,r){var a,c;return c=this,(a=this.events)[e]||(a[e]=[]),this.events[e].push(r),o(this,function(r){var o,a,s;return a=(s=c.handlers)[r]||(s[r]=n(this,c.events)),o=a.handleds,-1===o.indexOf(e)?(t(this,e,a),o.push(e)):void 0}),this},e.prototype.trigger=function(e,t){return null==t&&(t={}),o(this,function(){var n,r,o;n=document.createEvent("HTMLEvents"),n.initEvent(e,!0,!0);for(r in t)o=t[r],n[r]=o;return this.dispatchEvent(n)}),this},e.prototype.remove=function(){return o(this,function(){return this.parentNode?this.parentNode.removeChild(this):void 0}),this},e.prototype.replaceWith=function(e){return"string"==typeof e&&(e=new casua.Node(e)),o(this,function(t,n){return o(e,function(e,t){return n.parentNode?n.parentNode.replaceChild(t,n):void 0})}),this},e.prototype.val=function(e){return null!=e?(o(this,function(){return this.value=e}),this):this[0].value},e}(),_scopeInitParent=function(e,t){return e._childs=[],null!=t?(-1===t._childs.indexOf(e)&&t._childs.push(e),e._parent=t):void 0},_scopeRemovePrepare=function(e,t){var n,r;return e._data[t]instanceof casua.Scope&&(r=e._data[t],null!=r._parent&&(n=r._parent._childs.indexOf(r),r._parent._childs.splice(n,1))),_scopeCallWatch(e,e._data[t],t,"$delete")},_scopeCallWatch=function(e,t,n,r){var o,a,c,s,i,_,u,h,l;if("string"==typeof r&&"$"===r.charAt(0))return _scopeCallAltWatch(e,t,n,r);if(e._watches[r])for(u=e._watches[r],c=0,i=u.length;i>c;c++)a=u[c],a.call(e,t,n,r);for(h=e._childs,l=[],s=0,_=h.length;_>s;s++)o=h[s],null==o._data[r]?l.push(_scopeCallWatch(o,t,n,r)):l.push(void 0);return l},_scopeCallAltWatch=function(e,t,n,r){var o,a,c,s,i;if(e._watches[r]){for(s=e._watches[r],i=[],a=0,c=s.length;c>a;a++)o=s[a],i.push(o.call(e,t,r,n));return i}},__mutiple_levels_key_regexp=/^([^\.]+)\.(.+)$/,casua.Scope=function(){function e(e,t){var n,r;if(e instanceof casua.Scope)return e;if(null!=e.length)return new casua.ArrayScope(e,t);_scopeInitParent(this,t),this._watches={},this._data={};for(n in e)r=e[n],this.set(n,r)}return e.prototype.get=function(e){var t,n;return this._watch_lists&&-1===this._watch_lists.indexOf(e)&&this._watch_lists.push(e),"string"==typeof e&&(t=e.match(__mutiple_levels_key_regexp))?this.get(t[1]).get(t[2]):"$parent"===e?this._parent:(n=this._data[e],null==n&&null!=this._parent&&(n=this._parent.get(e)),n)},e.prototype.set=function(e,t){var n,r;return"string"==typeof e&&(r=e.match(__mutiple_levels_key_regexp))?this.get(r[1]).set(r[2],t):"string"==typeof e&&"$"===e.charAt(0)||("object"==typeof t&&(t=new casua.Scope(t,this)),this._data[e]===t)?void 0:(n=this._data[e],this._data[e]=t,null==n&&_scopeCallWatch(this,t,e,"$add"),_scopeCallWatch(this,t,n,e))},e.prototype.remove=function(e){var t;return"string"==typeof e&&(t=e.match(__mutiple_levels_key_regexp))?this.get(t[1]).remove(t[2]):(_scopeRemovePrepare(this,e),delete this._data[e])},e.prototype.$watch=function(e,t){var n,r;return"string"==typeof e&&(n=e.match(__mutiple_levels_key_regexp))?this.get(n[1]).$watch(n[2],t):((r=this._watches)[e]||(r[e]=[]),this._watches[e].push(t))},e.prototype.$startGetWatches=function(){return this._watch_lists=[]},e.prototype.$stopGetWatches=function(){var e,t;return e=function(){var e,n,r,o;for(r=this._watch_lists,o=[],e=0,n=r.length;n>e;e++)t=r[e],o.push(t);return o}.call(this),delete this._watch_lists,e},e}(),_scopeChangeLength=function(e,t){var n,r;return r=e._data.length,n=t.call(e),_scopeCallWatch(e,e._data.length,r,"length"),n},casua.ArrayScope=function(e){function t(e,t){var n,r,o,a;if(e instanceof casua.Scope)return e;if(null==e.length)return new casua.Scope(e,t);for(_scopeInitParent(this,t),this._watches={},this._data=[],n=o=0,a=e.length;a>o;n=++o)r=e[n],this.set(n,r)}return __extends(t,e),t.prototype.length=function(){return this._data.length},t.prototype.remove=function(e){return _scopeChangeLength(this,function(){return _scopeRemovePrepare(this,e),this._data.splice(e,1)})},t.prototype.each=function(e){var t,n,r,o,a,c;for(a=this._data,c=[],t=r=0,o=a.length;o>r;t=++r)n=a[t],c.push(e.call(this,this.get(t),t));return c},t.prototype.pop=function(){return this.remove(this._data.length-1)[0]},t.prototype.shift=function(){return this.remove(0)[0]},t.prototype.push=function(){var e;return e=arguments,_scopeChangeLength(this,function(){var t,n,r;for(n=0,r=e.length;r>n;n++)t=e[n],this.set(this._data.length,t);return this._data.length})},t.prototype.unshift=function(){var e,t,n,r;return r=this._data.length,this.push.apply(this,arguments),n=function(){var n,o,a,c;for(a=this._data,c=[],e=n=0,o=a.length;o>n;e=++n)t=a[e],r>e?c.push(e+arguments.length):c.push(e-r);return c}.apply(this,arguments),_scopeCallWatch(this,n,null,"$move"),_scopeCallWatch(this,this._data.length,r,"length"),this._data.length},t.prototype.reverse=function(){var e,t,n;return this._data.reverse(),n=function(){var n,r,o,a;for(o=this._data,a=[],e=n=0,r=o.length;r>n;e=++n)t=o[e],a.push(this._data.length-1-e);return a}.call(this),_scopeCallWatch(this,n,null,"$move"),this},t.prototype.sort=function(e){var t,n,r,o,a;return o=this,a=function(){var e,r,o,a;for(o=this._data,a=[],t=e=0,r=o.length;r>e;t=++e)n=o[t],a.push({e:n,o:t});return a}.call(this),a.sort(function(t,n){return e.call(o,t.e,n.e)}),r=[],this._data=function(){var e,o,c;for(c=[],t=e=0,o=a.length;o>e;t=++e)n=a[t],r[n.o]=t,c.push(n.e);return c}(),_scopeCallWatch(this,r,null,"$move"),this},t}(casua.Scope),casua.defineController=function(init_fn){var __computeBind,__compute_controller_method_regexp,__compute_controller_regexp,__compute_match_key_regexp,__compute_match_regexp,__compute_scope_key_regexp,__compute_scope_regexp,__keep_original_attr_regexp,__nodeAttrBind,__nodeBind,__nodeCondition,__nodeValueBind,__resolveMethod,_renderNode,_renderNodes;return _renderNode=function(e,t,n,r){var o,a,c,s,i,_,u,h;if(t instanceof casua.ArrayScope)return _renderNodes(e,t,n,r);if(r["@controller"])return s=_shallowCopy(r),c=new r["@controller"](t,e),delete s["@controller"],_renderNode(c,t,n,s);h=[];for(_ in r)if(o=r[_],"@"===_.charAt(0)){if(u=_.toLowerCase().match(/^@(\w+)(?: (\S+))?$/))switch(u[1]){case"on":a=o.match(/^@?(\S+)(?:\(\))?$/),n.on(u[2],__resolveMethod(e,a[1]));break;case"html":case"text":__nodeBind(e,n,u[1],t,o);break;case"val":__nodeValueBind(e,n,t,o);break;case"attr":__nodeAttrBind(e,n,u[2],t,o);break;case"class":__nodeAttrBind(e,n,u[1],t,o);break;case"child":_renderNode(e,t.get(u[2]),n,o);break;case"if":__nodeCondition(e,n,u[1],t,o)}}else i=new casua.Node(_),h.push(i),n.append(i),"object"==typeof o?_renderNode(e,t,i,o):__nodeBind(e,i,"text",t,o);return h},_renderNodes=function(e,t,n,r){var o,a;return n.empty(),a=[],o=function(t,o,c){return a[c]=_renderNode(e,t,n,r)},t.$watch("$add",o),t.$watch("$delete",function(e,t,n){var r,o,c,s,i;for(o=a.splice(n,1)[0],i=[],c=0,s=o.length;s>c;c++)r=o[c],i.push(r.remove());return i}),t.$watch("$move",function(e){var t,r,o,c,s,i,_,u,h,l;for(h=[],c=s=0,_=e.length;_>s;c=++s)t=e[c],h[t]=a[c];for(a=h,n.empty(),l=[],i=0,u=a.length;u>i;i++)o=a[i],l.push(function(){var e,t,a;for(a=[],e=0,t=o.length;t>e;e++)r=o[e],a.push(n.append(r));return a}());return l}),t.each(function(e,t){return o.call({},e,null,t)})},__nodeBind=function(e,t,n,r,o){return __computeBind(e,r,o,function(e){return t[n].call(t,e)})},__keep_original_attr_regexp=/^class$/,__nodeAttrBind=function(e,t,n,r,o){var a,c,s,i;return c=n.match(__keep_original_attr_regexp)&&(a=t.attr(n))?a+" ":void 0,__computeBind(e,r,o,function(e){return null!=c&&(e=c+e),t.attr(n,e)}),n.match(__boolean_attr_regexp)&&(s=o.match(__compute_scope_key_regexp))?(i=function(){return r.set(s[1],t.attr(n))},t.on("click",i)):void 0},__nodeValueBind=function(e,t,n,r){var o,a,c,s,i,_,u,h;if(!(c=r.match(__compute_scope_key_regexp)))return __nodeBind(e,_root,"val",n,child);for(o=function(){return t.val(n.get(c[1]))},s=function(){return n.set(c[1],t.val())},t.on("change",s),t.on("keyup",s),n.$startGetWatches(),o.call(n),u=n.$stopGetWatches(),h=[],i=0,_=u.length;_>i;i++)a=u[i],h.push(n.$watch(a,o));return h},__nodeCondition=function(e,t,n,r,o){var a,c,s;return a=s=t,c=new casua.Node("<!-- -->"),__computeBind(e,r,o,function(e){return e?(a.replaceWith(s),a=s):(a.replaceWith(c),a=c)},!0)},__compute_match_regexp=/\{\{([\S^\}]+)\}\}/g,__compute_match_key_regexp=/^\{\{([\S^\}]+)\}\}$/,__compute_scope_regexp=/@(\S+)/g,__compute_scope_key_regexp=/^@(\S+)$/,__compute_controller_regexp=/@(\S+)\(\)/g,__compute_controller_method_regexp=/^@(\S+)\(\)$/,__computeBind=function(_controller,_scope,src,fn,to_eval){var key,keys_to_watch,method,r,watch_fn,_i,_len,_ref,_results;for(null==to_eval&&(to_eval=!1),keys_to_watch=[],watch_fn=(r=src.match(__compute_controller_method_regexp))?(method=__resolveMethod(_controller,r[1]),function(){return fn.call({},method.call(_controller))}):(r=src.match(__compute_scope_key_regexp))?function(){return fn.call({},this.get(r[1]))}:(r=src.match(__compute_match_regexp))?function(){var e;return e=this,fn.call({},src.replace(__compute_match_regexp,function(t){return t=t.match(__compute_match_key_regexp),e.get(t[1])}))}:to_eval?(src=src.replace(__compute_controller_regexp,function(e){return e=e.match(__compute_controller_method_regexp),method=__resolveMethod(_controller,e[1]),"method.call(_controller)"}),src=src.replace(__compute_scope_regexp,function(e){return e=e.match(__compute_scope_key_regexp),'_scope.get("'+e[1]+'")'}),function(){return fn.call({},eval(src))}):function(){return fn.call({},src)},_scope.$startGetWatches(),watch_fn.call(_scope),_ref=_scope.$stopGetWatches(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_results.push(_scope.$watch(key,watch_fn));return _results},__resolveMethod=function(e,t){var n,r;for(n=e;;){if(r=null!=n.methods?n.methods[t]:void 0,null!=r)break;if(!(n=n._parent))break}return r},function(){function e(e,t){this._parent=t,this.scope=new casua.Scope(e),this.methods=init_fn.call(this,this.scope,this,this._parent)}return e.prototype.renderAt=function(e,t){return _renderNode(this,this.scope,new casua.Node(e).empty(),t)},e.prototype.render=function(e){var t;return t=new casua.Node(document.createElement("div")),_renderNode(this,this.scope,t,e),t},e}()},window.casua=casua}).call(this);