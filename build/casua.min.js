(function(){var casua,k,v,__boolean_attr_regexp,_escapeHTML,_escape_chars,_reversed_escape_chars,_scopeCallAltWatch,_scopeCallWatch,_scopeInitParent,_scopeRemovePrepare,_shallowCopy,__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};_shallowCopy=function(t,e){var n,r;null==e&&(e={});for(n in t)r=t[n],e[n]=r;return e},_escape_chars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"},_reversed_escape_chars={};for(k in _escape_chars)v=_escape_chars[k],_reversed_escape_chars[v]=k;_escapeHTML=function(t){return t.replace(/[&<>"']/g,function(t){return"&"+_reversed_escape_chars[t]+";"})},__boolean_attr_regexp=/^multiple|selected|checked|disabled|required|open$/,casua={},casua.Node=function(){function t(t){var e,n,o,a,c,s,i,u,_,h,l,p;if(this.handlers={},this.events={},this.length=0,t instanceof casua.Node)return t;if("string"==typeof t)if("<"!==t.charAt(0))for(n=t.split(" "),i=n.shift(),c=document.createElement((s=i.match(/^([^\.^#]+)/))?s[1]:"div"),(s=i.match(/\.([^\.^#]+)/g))&&(c.className=s.join(" ").replace(/\./g,"")),(s=i.match(/#([^\.^#]+)/))&&(c.id=s[1]),r(this,c),u=0,h=n.length;h>u;u++)e=n[u],"#"!==e.charAt(0)&&(s=e.match(/^([^=]+)(?:=(['"])(.+?)\2)?$/))&&this.attr(s[1],s[3]||s[1]);else for(a=document.createElement("div"),a.innerHTML="<div>&#160;</div>"+t,a.removeChild(a.firstChild),p=a.childNodes,_=0,l=p.length;l>_;_++)o=p[_],r(this,o);else t.nodeName&&r(this,t)}var e,n,r,o,a;return r=function(t,e){var n,r,o,c;for(e.nodeName&&(e=[e]),c=[],r=0,o=e.length;o>r;r++)n=e[r],c.push(a(t,n));return c},a=function(t,e){return t[t.length]=e,t.length+=1},o=function(t,e){var n,r,o;return o=function(){var o,a,c;for(c=[],n=o=0,a=t.length;a>o;n=++o)r=t[n],c.push(e.call(r,n,r));return c}(),o[0]},e=window.document.addEventListener?function(t,e,n){return t.addEventListener(e,n,!1)}:function(t,e,n){return t.attachEvent("on"+e,n)},n=function(t,e){var n;return n=function(n,r){var o,a,c,s;n.preventDefault||(n.preventDefault=function(){return n.returnValue=!1}),n.stopPropagation||(n.stopPropagation=function(){return n.cancelBubble=!0}),n.target||(n.target=n.srcElement||document),null==n.defaultPrevented&&(s=n.preventDefault,n.preventDefault=function(){return n.defaultPrevented=!0,s.call(n)},n.defaultPrevented=!1),n.isDefaultPrevented=function(){return n.defaultPrevented||n.returnValue===!1},o=_shallowCopy(e[r||n.type]||[]);for(c in o)a=o[c],a.call(t,n);return delete n.preventDefault,delete n.stopPropagation,delete n.isDefaultPrevented},n.elem=t,n.handleds=[],n},t.prototype.attr=function(t,e){return t=t.toLowerCase(),t.match(/^val|value$/)?this.val(e):t.match(__boolean_attr_regexp)?null!=e?e?o(this,function(){return this.setAttribute(t,t),this[t]=!0}):o(this,function(){return this.removeAttribute(t),this[t]=!1}):this[0][t]:null!=e?(o(this,function(){return this.setAttribute(t,e)}),this):this[0].getAttribute(t,2)},t.prototype.append=function(t){return"string"==typeof t&&(t=new casua.Node(t)),o(this,function(e,n){return o(t,function(t,e){return n.appendChild(e)})}),this},t.prototype.empty=function(){return o(this,function(){var t;for(t=[];this.firstChild;)t.push(this.removeChild(this.firstChild));return t}),this},t.prototype.html=function(t){return null!=t?(this.empty(),o(this,function(){return this.innerHTML=t}),this):this[0].innerHTML},t.prototype.text=function(t){return null!=t?this.html(_escapeHTML(t)):this.html()},t.prototype.on=function(t,r){var a,c;return c=this,(a=this.events)[t]||(a[t]=[]),this.events[t].push(r),o(this,function(r){var o,a,s;return a=(s=c.handlers)[r]||(s[r]=n(this,c.events)),o=a.handleds,-1===o.indexOf(t)?(e(this,t,a),o.push(t)):void 0}),this},t.prototype.trigger=function(t,e){return null==e&&(e={}),o(this,function(){var n,r,o;n=document.createEvent("HTMLEvents"),n.initEvent(t,!0,!0);for(r in e)o=e[r],n[r]=o;return this.dispatchEvent(n)}),this},t.prototype.remove=function(){return o(this,function(){return this.parentNode?this.parentNode.removeChild(this):void 0}),this},t.prototype.replaceWith=function(t){return"string"==typeof t&&(t=new casua.Node(t)),o(this,function(e,n){return o(t,function(t,e){return n.parentNode?n.parentNode.replaceChild(e,n):void 0})}),this},t.prototype.val=function(t){return null!=t?(o(this,function(){return this.value=t}),this):this[0].value},t}(),_scopeInitParent=function(t,e){return t._childs=[],null!=e?(-1===e._childs.indexOf(t)&&e._childs.push(t),t._parent=e):void 0},_scopeRemovePrepare=function(t,e){var n,r;return t._data[e]instanceof casua.Scope&&(r=t._data[e],null!=r._parent&&(n=r._parent._childs.indexOf(r),r._parent._childs.splice(n,1))),_scopeCallWatch(t,t._data[e],e,"$delete")},_scopeCallWatch=function(t,e,n,r){var o,a,c,s,i,u,_,h,l;if("string"==typeof r&&"$"===r.charAt(0))return _scopeCallAltWatch(t,e,n,r);if(t._watches[r])for(_=t._watches[r],c=0,i=_.length;i>c;c++)a=_[c],a.call(t,e,n,r);for(h=t._childs,l=[],s=0,u=h.length;u>s;s++)o=h[s],null==o._data[r]?l.push(_scopeCallWatch(o,e,n,r)):l.push(void 0);return l},_scopeCallAltWatch=function(t,e,n,r){var o,a,c,s,i;if(t._watches[r]){for(s=t._watches[r],i=[],a=0,c=s.length;c>a;a++)o=s[a],i.push(o.call(t,e,r,n));return i}},casua.Scope=function(){function t(t,e){var n,r;if(t instanceof casua.Scope)return t;if(null!=t.length)return new casua.ArrayScope(t,e);_scopeInitParent(this,e),this._watches={},this._data={};for(n in t)r=t[n],this.set(n,r)}return t.prototype.get=function(t){var e;return this._watch_lists&&-1===this._watch_lists.indexOf(t)&&this._watch_lists.push(t),e=this._data[t],null==e&&null!=this._parent&&(e=this._parent.get(t)),e},t.prototype.set=function(t,e){var n;return"string"==typeof t&&"$"===t.charAt(0)||("object"==typeof e&&(e=new casua.Scope(e,this)),this._data[t]===e)?void 0:(n=this._data[t],this._data[t]=e,null==n&&_scopeCallWatch(this,e,t,"$add"),_scopeCallWatch(this,e,n,t))},t.prototype.remove=function(t){return _scopeRemovePrepare(this,t),delete this._data[t]},t.prototype.$watch=function(t,e){var n;return(n=this._watches)[t]||(n[t]=[]),this._watches[t].push(e)},t.prototype.$startGetWatches=function(){return this._watch_lists=[]},t.prototype.$stopGetWatches=function(){var t,e;return t=function(){var t,n,r,o;for(r=this._watch_lists,o=[],t=0,n=r.length;n>t;t++)e=r[t],o.push(e);return o}.call(this),delete this._watch_lists,t},t}(),casua.ArrayScope=function(t){function e(t,e){var n,r,o,a;if(t instanceof casua.Scope)return t;if(null==t.length)return new casua.Scope(t,e);for(_scopeInitParent(this,e),this._watches={},this._data=[],n=o=0,a=t.length;a>o;n=++o)r=t[n],this.set(n,r)}return __extends(e,t),e.prototype.length=function(){return this._data.length},e.prototype.remove=function(t){return _scopeRemovePrepare(this,t),this._data.splice(t,1)},e.prototype.each=function(t){var e,n,r,o,a,c;for(a=this._data,c=[],e=r=0,o=a.length;o>r;e=++r)n=a[e],c.push(t.call(this,this.get(e),e));return c},e.prototype.pop=function(){return this.remove(this._data.length-1)[0]},e.prototype.shift=function(){return this.remove(0)[0]},e.prototype.push=function(){var t,e,n;for(e=0,n=arguments.length;n>e;e++)t=arguments[e],this.set(this._data.length,t);return this._data.length},e.prototype.unshift=function(){var t,e,n,r;return r=this._data.length,this.push.apply(this,arguments),n=function(){var n,o,a,c;for(a=this._data,c=[],t=n=0,o=a.length;o>n;t=++n)e=a[t],r>t?c.push(t+arguments.length):c.push(t-r);return c}.apply(this,arguments),_scopeCallWatch(this,n,null,"$move"),this._data.length},e.prototype.reverse=function(){var t,e,n;return this._data.reverse(),n=function(){var n,r,o,a;for(o=this._data,a=[],t=n=0,r=o.length;r>n;t=++n)e=o[t],a.push(this._data.length-1-t);return a}.call(this),_scopeCallWatch(this,n,null,"$move"),this},e.prototype.sort=function(t){var e,n,r,o,a;return o=this,a=function(){var t,r,o,a;for(o=this._data,a=[],e=t=0,r=o.length;r>t;e=++t)n=o[e],a.push({e:n,o:e});return a}.call(this),a.sort(function(e,n){return t.call(o,e.e,n.e)}),r=[],this._data=function(){var t,o,c;for(c=[],e=t=0,o=a.length;o>t;e=++t)n=a[e],r[n.o]=e,c.push(n.e);return c}(),_scopeCallWatch(this,r,null,"$move"),this},e}(casua.Scope),casua.defineController=function(init_fn){var __computeBind,__compute_controller_method_regexp,__compute_controller_regexp,__compute_match_key_regexp,__compute_match_regexp,__compute_scope_key_regexp,__compute_scope_regexp,__keep_original_attr_regexp,__nodeAttrBind,__nodeBind,__nodeCondition,__nodeValueBind,_renderNode,_renderNodes;return _renderNode=function(t,e,n,r){var o,a,c,s,i,u,_,h;if(e instanceof casua.ArrayScope)return _renderNodes(t,e,n,r);if(r["@controller"])return s=_shallowCopy(r),c=new r["@controller"](e),delete s["@controller"],_renderNode(c,e,n,s);h=[];for(u in r)if(o=r[u],"@"===u.charAt(0)){if(_=u.toLowerCase().match(/^@(\w+)(?: (\S+))?$/))switch(_[1]){case"on":a=o.match(/^@?(\S+)(?:\(\))?$/),n.on(_[2],t.methods[a[1]]);break;case"html":case"text":__nodeBind(t,n,_[1],e,o);break;case"val":__nodeValueBind(t,n,e,o);break;case"attr":__nodeAttrBind(t,n,_[2],e,o);break;case"class":__nodeAttrBind(t,n,_[1],e,o);break;case"child":_renderNode(t,e.get(_[2]),n,o);break;case"if":__nodeCondition(t,n,_[1],e,o)}}else i=new casua.Node(u),h.push(i),n.append(i),"object"==typeof o?_renderNode(t,e,i,o):__nodeBind(t,i,"text",e,o);return h},_renderNodes=function(t,e,n,r){var o,a;return n.empty(),a=[],o=function(e,o,c){return a[c]=_renderNode(t,e,n,r)},e.$watch("$add",o),e.$watch("$delete",function(t,e,n){var r,o,c,s,i;for(o=a.splice(n,1)[0],i=[],c=0,s=o.length;s>c;c++)r=o[c],i.push(r.remove());return i}),e.$watch("$move",function(t){var e,r,o,c,s,i,u,_,h,l;for(h=[],c=s=0,u=t.length;u>s;c=++s)e=t[c],h[e]=a[c];for(a=h,n.empty(),l=[],i=0,_=a.length;_>i;i++)o=a[i],l.push(function(){var t,e,a;for(a=[],t=0,e=o.length;e>t;t++)r=o[t],a.push(n.append(r));return a}());return l}),e.each(function(t,e){return o.call({},t,null,e)})},__nodeBind=function(t,e,n,r,o){return __computeBind(t,r,o,function(t){return e[n].call(e,t)})},__keep_original_attr_regexp=/^class$/,__nodeAttrBind=function(t,e,n,r,o){var a,c,s,i;return c=n.match(__keep_original_attr_regexp)&&(a=e.attr(n))?a+" ":void 0,__computeBind(t,r,o,function(t){return null!=c&&(t=c+t),e.attr(n,t)}),n.match(__boolean_attr_regexp)&&(s=o.match(__compute_scope_key_regexp))?(i=function(){return r.set(s[1],e.attr(n))},e.on("click",i)):void 0},__nodeValueBind=function(t,e,n,r){var o,a,c,s,i,u,_,h;if(!(c=r.match(__compute_scope_key_regexp)))return __nodeBind(t,_root,"val",n,child);for(o=function(){return e.val(n.get(c[1]))},s=function(){return n.set(c[1],e.val())},e.on("change",s),e.on("keyup",s),n.$startGetWatches(),o.call(n),_=n.$stopGetWatches(),h=[],i=0,u=_.length;u>i;i++)a=_[i],h.push(n.$watch(a,o));return h},__nodeCondition=function(t,e,n,r,o){var a,c,s;return a=s=e,c=new casua.Node("<!-- -->"),__computeBind(t,r,o,function(t){return t?(a.replaceWith(s),a=s):(a.replaceWith(c),a=c)},!0)},__compute_match_regexp=/\{\{([\S^\}]+)\}\}/g,__compute_match_key_regexp=/^\{\{([\S^\}]+)\}\}$/,__compute_scope_regexp=/@(\S+)/g,__compute_scope_key_regexp=/^@(\S+)$/,__compute_controller_regexp=/@(\S+)\(\)/g,__compute_controller_method_regexp=/^@(\S+)\(\)$/,__computeBind=function(_controller,_scope,src,fn,to_eval){var key,keys_to_watch,r,watch_fn,_i,_len,_ref,_results;for(null==to_eval&&(to_eval=!1),keys_to_watch=[],watch_fn=(r=src.match(__compute_controller_method_regexp))?function(){return fn.call({},_controller.methods[r[1]].call(_controller))}:(r=src.match(__compute_scope_key_regexp))?function(){return fn.call({},this.get(r[1]))}:(r=src.match(__compute_match_regexp))?function(){var t;return t=this,fn.call({},src.replace(__compute_match_regexp,function(e){return e=e.match(__compute_match_key_regexp),t.get(e[1])}))}:to_eval?(src=src.replace(__compute_controller_regexp,function(t){return t=t.match(__compute_controller_method_regexp),"_controller.methods."+t[1]+".call(_controller)"}),src=src.replace(__compute_scope_regexp,function(t){return t=t.match(__compute_scope_key_regexp),'_scope.get("'+t[1]+'")'}),function(){return fn.call({},eval(src))}):function(){return fn.call({},src)},_scope.$startGetWatches(),watch_fn.call(_scope),_ref=_scope.$stopGetWatches(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_results.push(_scope.$watch(key,watch_fn));return _results},function(){function t(t){this.scope=new casua.Scope(t),this.methods=init_fn.call(this,this.scope,this)}return t.prototype.renderAt=function(t,e){return _renderNode(this,this.scope,new casua.Node(t).empty(),e)},t.prototype.render=function(t){var e;return e=new casua.Node(document.createElement("div")),_renderNode(this,this.scope,e,t),e},t}()},window.casua=casua}).call(this);