(function(){var casua,k,v,_escapeHTML,_escape_chars,_reversed_escape_chars,_scopeCallAltWatch,_scopeCallWatch,_scopeInitParent,_scopeRemovePrepare,_shallowCopy,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};_shallowCopy=function(t,e){var r,n;null==e&&(e={});for(r in t)n=t[r],e[r]=n;return e},_escape_chars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"},_reversed_escape_chars={};for(k in _escape_chars)v=_escape_chars[k],_reversed_escape_chars[v]=k;_escapeHTML=function(t){return t.replace(/[&<>"']/g,function(t){return"&"+_reversed_escape_chars[t]+";"})},casua={},casua.Node=function(){function t(t){var e,r,o,a,c,s,i,u,h,_,l,p;if(this.handlers={},this.events={},this.length=0,t instanceof casua.Node)return t;if("string"==typeof t)if("<"!==t.charAt(0))for(r=t.split(" "),i=r.shift(),c=document.createElement((s=i.match(/^([^\.^#]+)/))?s[1]:"div"),(s=i.match(/\.([^\.^#]+)/g))&&(c.className=s.join(" ").replace(/\./g,"")),(s=i.match(/#([^\.^#]+)/))&&(c.id=s[1]),n(this,c),u=0,_=r.length;_>u;u++)e=r[u],"#"!==e.charAt(0)&&(s=e.match(/^([^=]+)(?:=(['"])(.+?)\2)?$/))&&this.attr(s[1],s[3]||"");else for(a=document.createElement("div"),a.innerHTML="<div>&#160;</div>"+t,a.removeChild(a.firstChild),p=a.childNodes,h=0,l=p.length;l>h;h++)o=p[h],n(this,o);else t.nodeName&&n(this,t)}var e,r,n,o,a;return n=function(t,e){var r,n,o,c;for(e.nodeName&&(e=[e]),c=[],n=0,o=e.length;o>n;n++)r=e[n],c.push(a(t,r));return c},a=function(t,e){return t[t.length]=e,t.length+=1},o=function(t,e){var r,n,o;return o=function(){var o,a,c;for(c=[],r=o=0,a=t.length;a>o;r=++o)n=t[r],c.push(e.call(n,r,n));return c}(),o[0]},e=window.document.addEventListener?function(t,e,r){return t.addEventListener(e,r,!1)}:function(t,e,r){return t.attachEvent("on"+e,r)},r=function(t,e){var r;return r=function(r,n){var o,a,c,s;r.preventDefault||(r.preventDefault=function(){return r.returnValue=!1}),r.stopPropagation||(r.stopPropagation=function(){return r.cancelBubble=!0}),r.target||(r.target=r.srcElement||document),null==r.defaultPrevented&&(s=r.preventDefault,r.preventDefault=function(){return r.defaultPrevented=!0,s.call(r)},r.defaultPrevented=!1),r.isDefaultPrevented=function(){return r.defaultPrevented||r.returnValue===!1},o=_shallowCopy(e[n||r.type]||[]);for(c in o)a=o[c],a.call(t,r);return delete r.preventDefault,delete r.stopPropagation,delete r.isDefaultPrevented},r.elem=t,r.handleds=[],r},t.prototype.attr=function(t,e){return t=t.toLowerCase(),null!=e?(o(this,function(){return this.setAttribute(t,e)}),this):this[0].getAttribute(t,2)},t.prototype.append=function(t){return"string"==typeof t&&(t=new casua.Node(t)),o(this,function(e,r){return o(t,function(t,e){return r.appendChild(e)})}),this},t.prototype.empty=function(){return o(this,function(){var t;for(t=[];this.firstChild;)t.push(this.removeChild(this.firstChild));return t}),this},t.prototype.html=function(t){return null!=t?(this.empty(),o(this,function(){return this.innerHTML=t}),this):this[0].innerHTML},t.prototype.text=function(t){return null!=t?this.html(_escapeHTML(t)):this.html()},t.prototype.on=function(t,n){var a,c;return c=this,(a=this.events)[t]||(a[t]=[]),this.events[t].push(n),o(this,function(n){var o,a,s;return a=(s=c.handlers)[n]||(s[n]=r(this,c.events)),o=a.handleds,-1===o.indexOf(t)?(e(this,t,a),o.push(t)):void 0}),this},t.prototype.trigger=function(t,e){return null==e&&(e={}),o(this,function(){var r,n,o;r=document.createEvent("HTMLEvents"),r.initEvent(t,!0,!0);for(n in e)o=e[n],r[n]=o;return this.dispatchEvent(r)}),this},t.prototype.remove=function(){return o(this,function(){return this.parentNode?this.parentNode.removeChild(this):void 0}),this},t.prototype.replaceWith=function(t){return"string"==typeof t&&(t=new casua.Node(t)),o(this,function(e,r){return o(t,function(t,e){return r.parentNode?r.parentNode.replaceChild(e,r):void 0})}),this},t}(),_scopeInitParent=function(t,e){return t._childs=[],null!=e?(-1===e._childs.indexOf(t)&&e._childs.push(t),t._parent=e):void 0},_scopeRemovePrepare=function(t,e){var r,n;return t._data[e]instanceof casua.Scope&&(n=t._data[e],null!=n._parent&&(r=n._parent._childs.indexOf(n),n._parent._childs.splice(r,1))),_scopeCallWatch(t,t._data[e],e,"$delete")},_scopeCallWatch=function(t,e,r,n){var o,a,c,s,i,u,h,_,l;if("string"==typeof n&&"$"===n.charAt(0))return _scopeCallAltWatch(t,e,r,n);if(t._watches[n])for(h=t._watches[n],c=0,i=h.length;i>c;c++)a=h[c],a.call(t,e,r,n);for(_=t._childs,l=[],s=0,u=_.length;u>s;s++)o=_[s],null==o._data[n]?l.push(_scopeCallWatch(o,e,r,n)):l.push(void 0);return l},_scopeCallAltWatch=function(t,e,r,n){var o,a,c,s,i;if(t._watches[n]){for(s=t._watches[n],i=[],a=0,c=s.length;c>a;a++)o=s[a],i.push(o.call(t,e,n,r));return i}},casua.Scope=function(){function t(t,e){var r,n;if(t instanceof casua.Scope)return t;if(null!=t.length)return new casua.ArrayScope(t,e);_scopeInitParent(this,e),this._watches={},this._data={};for(r in t)n=t[r],this.set(r,n)}return t.prototype.get=function(t){var e;return this._watch_lists&&-1===this._watch_lists.indexOf(t)&&this._watch_lists.push(t),e=this._data[t],null==e&&null!=this._parent&&(e=this._parent.get(t)),e},t.prototype.set=function(t,e){var r;return"string"==typeof t&&"$"===t.charAt(0)||("object"==typeof e&&(e=new casua.Scope(e,this)),this._data[t]===e)?void 0:(r=this._data[t],this._data[t]=e,null==r&&_scopeCallWatch(this,e,t,"$add"),_scopeCallWatch(this,e,r,t))},t.prototype.remove=function(t){return _scopeRemovePrepare(this,t),delete this._data[t]},t.prototype.$watch=function(t,e){var r;return(r=this._watches)[t]||(r[t]=[]),this._watches[t].push(e)},t.prototype.$startGetWatches=function(){return this._watch_lists=[]},t.prototype.$stopGetWatches=function(){var t,e;return t=function(){var t,r,n,o;for(n=this._watch_lists,o=[],t=0,r=n.length;r>t;t++)e=n[t],o.push(e);return o}.call(this),delete this._watch_lists,t},t}(),casua.ArrayScope=function(t){function e(t,e){var r,n,o,a;if(t instanceof casua.Scope)return t;if(null==t.length)return new casua.Scope(t,e);for(_scopeInitParent(this,e),this._watches={},this._data=[],r=o=0,a=t.length;a>o;r=++o)n=t[r],this.set(r,n)}return __extends(e,t),e.prototype.length=function(){return this._data.length},e.prototype.remove=function(t){return _scopeRemovePrepare(this,t),this._data.splice(t,1)},e.prototype.each=function(t){var e,r,n,o,a,c;for(a=this._data,c=[],e=n=0,o=a.length;o>n;e=++n)r=a[e],c.push(t.call(this,this.get(e),e));return c},e.prototype.pop=function(){return this.remove(this._data.length-1)[0]},e.prototype.shift=function(){return this.remove(0)[0]},e.prototype.push=function(){var t,e,r;for(e=0,r=arguments.length;r>e;e++)t=arguments[e],this.set(this._data.length,t);return this._data.length},e.prototype.unshift=function(){var t,e,r,n;return n=this._data.length,this.push.apply(this,arguments),r=function(){var r,o,a,c;for(a=this._data,c=[],t=r=0,o=a.length;o>r;t=++r)e=a[t],n>t?c.push(t+arguments.length):c.push(t-n);return c}.apply(this,arguments),_scopeCallWatch(this,r,null,"$move"),this._data.length},e.prototype.reverse=function(){var t,e,r;return this._data.reverse(),r=function(){var r,n,o,a;for(o=this._data,a=[],t=r=0,n=o.length;n>r;t=++r)e=o[t],a.push(this._data.length-1-t);return a}.call(this),_scopeCallWatch(this,r,null,"$move"),this},e.prototype.sort=function(t){var e,r,n,o,a;return o=this,a=function(){var t,n,o,a;for(o=this._data,a=[],e=t=0,n=o.length;n>t;e=++t)r=o[e],a.push({e:r,o:e});return a}.call(this),a.sort(function(e,r){return t.call(o,e.e,r.e)}),n=[],this._data=function(){var t,o,c;for(c=[],e=t=0,o=a.length;o>t;e=++t)r=a[e],n[r.o]=e,c.push(r.e);return c}(),_scopeCallWatch(this,n,null,"$move"),this},e}(casua.Scope),casua.defineController=function(init_fn){var __computeBind,__compute_controller_method_regexp,__compute_controller_regexp,__compute_match_key_regexp,__compute_match_regexp,__compute_scope_key_regexp,__compute_scope_regexp,__nodeBind,__nodeCondition,_renderNode,_renderNodes;return _renderNode=function(t,e,r,n){var o,a,c,s,i,u,h;if(e instanceof casua.ArrayScope)return _renderNodes(t,e,r,n);if(n["@controller"])return c=_shallowCopy(n),a=new n["@controller"](e),delete c["@controller"],_renderNode(a,e,r,c);h=[];for(i in n)if(o=n[i],"@"===i.charAt(0))if(u=i.toLowerCase().match(/^@(\w+)(?: (\S+))?$/))switch(u[1]){case"on":h.push(r.on(u[2],t.methods[o]));break;case"html":case"text":h.push(__nodeBind(t,r,u[1],e,o));break;case"child":h.push(_renderNode(t,e.get(u[2]),r,o));break;case"if":h.push(__nodeCondition(t,r,u[1],e,o));break;default:h.push(void 0)}else h.push(void 0);else s=new casua.Node(i),r.append(s),"object"==typeof o?_renderNode(t,e,s,o):__nodeBind(t,s,"text",e,o),h.push(s);return h},_renderNodes=function(t,e,r,n){var o,a;return r.empty(),a=[],o=function(e,o,c){return a[c]=_renderNode(t,e,r,n)},e.$watch("$add",o),e.$watch("$delete",function(t,e,r){var n,o,c,s,i;for(o=a.splice(r,1)[0],i=[],c=0,s=o.length;s>c;c++)n=o[c],i.push(n.remove());return i}),e.$watch("$move",function(t){var e,n,o,c,s,i,u,h,_,l;for(_=[],c=s=0,u=t.length;u>s;c=++s)e=t[c],_[e]=a[c];for(a=_,r.empty(),l=[],i=0,h=a.length;h>i;i++)o=a[i],l.push(function(){var t,e,a;for(a=[],t=0,e=o.length;e>t;t++)n=o[t],a.push(r.append(n));return a}());return l}),e.each(function(t,e){return o.call({},t,null,e)})},__nodeBind=function(t,e,r,n,o){return __computeBind(t,n,o,function(t){return e[r].call(e,t)})},__nodeCondition=function(t,e,r,n,o){var a,c,s;return a=s=e,c=new casua.Node("<!-- -->"),__computeBind(t,n,o,function(t){return t?(a.replaceWith(s),a=s):(a.replaceWith(c),a=c)},!0)},__compute_match_regexp=/\{\{([\S^\}]+)\}\}/g,__compute_match_key_regexp=/^\{\{([\S^\}]+)\}\}$/,__compute_scope_regexp=/@(\S+)/g,__compute_scope_key_regexp=/^@(\S+)$/,__compute_controller_regexp=/@(\S+)\(\)/g,__compute_controller_method_regexp=/^@(\S+)\(\)$/,__computeBind=function(_controller,_scope,src,fn,to_eval){var key,keys_to_watch,r,ret,watch_fn,_i,_len,_ref;for(null==to_eval&&(to_eval=!1),keys_to_watch=[],watch_fn=(r=src.match(__compute_controller_method_regexp))?function(){return fn.call({},_controller.methods[r[1]].call(_controller))}:(r=src.match(__compute_scope_key_regexp))?function(){return fn.call({},this.get(r[1]))}:(r=src.match(__compute_match_regexp))?function(){var t;return t=this,fn.call({},src.replace(__compute_match_regexp,function(e){return e=e.match(__compute_match_key_regexp),t.get(e[1])}))}:to_eval?(src=src.replace(__compute_controller_regexp,function(t){return t=t.match(__compute_controller_method_regexp),"_controller.methods."+t[1]+".call(_controller)"}),src=src.replace(__compute_scope_regexp,function(t){return t=t.match(__compute_scope_key_regexp),'_scope.get("'+t[1]+'")'}),function(){return fn.call({},eval(src))}):function(){return fn.call({},src)},_scope.$startGetWatches(),ret=watch_fn.call(_scope),_ref=_scope.$stopGetWatches(),_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_scope.$watch(key,watch_fn);return ret},function(){function t(t){this.scope=new casua.Scope(t),this.methods=init_fn.call(this,this.scope,this)}return t.prototype.renderAt=function(t,e){return _renderNode(this,this.scope,new casua.Node(t).empty(),e)},t.prototype.render=function(t){var e;return e=new casua.Node(document.createElement("div")),_renderNode(this,this.scope,e,t),e},t}()},window.casua=casua}).call(this);