(function(){var casua,k,v,__boolean_attr_regexp,__mutiple_levels_key_regexp,_escapeHTML,_escape_chars,_reversed_escape_chars,_scopeCallAltWatch,_scopeCallWatch,_scopeChangeLength,_scopeInitParent,_scopeRemovePrepare,_shallowCopy,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};_shallowCopy=function(e,t){var r,n;null==t&&(t={});for(r in e)n=e[r],t[r]=n;return t},_escape_chars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"},_reversed_escape_chars={};for(k in _escape_chars)v=_escape_chars[k],_reversed_escape_chars[v]=k;_escapeHTML=function(e){return e.replace(/[&<>"']/g,function(e){return"&"+_reversed_escape_chars[e]+";"})},__boolean_attr_regexp=/^multiple|selected|checked|disabled|required|open$/,casua={},casua.Node=function(){function e(e){var t,r,o,a,c,s,i,_,u,h,l,p;if(this.handlers={},this.events={},this.length=0,e instanceof casua.Node)return e;if("string"==typeof e)if("<"!==e.charAt(0))for(r=e.split(" "),i=r.shift(),c=document.createElement((s=i.match(/^([^\.^#]+)/))?s[1]:"div"),(s=i.match(/\.([^\.^#]+)/g))&&(c.className=s.join(" ").replace(/\./g,"")),(s=i.match(/#([^\.^#]+)/))&&(c.id=s[1]),n(this,c),_=0,h=r.length;h>_;_++)t=r[_],"#"!==t.charAt(0)&&(s=t.match(/^([^=]+)(?:=(['"])(.+?)\2)?$/))&&this.attr(s[1],s[3]||s[1]);else for(a=document.createElement("div"),a.innerHTML="<div>&#160;</div>"+e,a.removeChild(a.firstChild),p=a.childNodes,u=0,l=p.length;l>u;u++)o=p[u],n(this,o);else e.nodeName&&n(this,e)}var t,r,n,o,a;return n=function(e,t){var r,n,o,c;for(t.nodeName&&(t=[t]),c=[],n=0,o=t.length;o>n;n++)r=t[n],c.push(a(e,r));return c},a=function(e,t){return e[e.length]=t,e.length+=1},o=function(e,t){var r,n,o;return o=function(){var o,a,c;for(c=[],r=o=0,a=e.length;a>o;r=++o)n=e[r],c.push(t.call(n,r,n));return c}(),o[0]},t=window.document.addEventListener?function(e,t,r){return e.addEventListener(t,r,!1)}:function(e,t,r){return e.attachEvent("on"+t,r)},r=function(e,t){var r;return r=function(r,n){var o,a,c,s;r.preventDefault||(r.preventDefault=function(){return r.returnValue=!1}),r.stopPropagation||(r.stopPropagation=function(){return r.cancelBubble=!0}),r.target||(r.target=r.srcElement||document),null==r.defaultPrevented&&(s=r.preventDefault,r.preventDefault=function(){return r.defaultPrevented=!0,s.call(r)},r.defaultPrevented=!1),r.isDefaultPrevented=function(){return r.defaultPrevented||r.returnValue===!1},o=_shallowCopy(t[n||r.type]||[]);for(c in o)a=o[c],a.call(e,r);return delete r.preventDefault,delete r.stopPropagation,delete r.isDefaultPrevented},r.elem=e,r.handleds=[],r},e.prototype.attr=function(e,t){return e=e.toLowerCase(),e.match(/^val|value$/)?this.val(t):e.match(__boolean_attr_regexp)?null!=t?t?o(this,function(){return this.setAttribute(e,e),this[e]=!0}):o(this,function(){return this.removeAttribute(e),this[e]=!1}):this[0][e]:null!=t?(o(this,function(){return this.setAttribute(e,t)}),this):this[0].getAttribute(e,2)},e.prototype.append=function(e){return"string"==typeof e&&(e=new casua.Node(e)),o(this,function(t,r){return o(e,function(e,t){return r.appendChild(t)})}),this},e.prototype.empty=function(){return o(this,function(){var e;for(e=[];this.firstChild;)e.push(this.removeChild(this.firstChild));return e}),this},e.prototype.html=function(e){return null!=e?(this.empty(),o(this,function(){return this.innerHTML=e}),this):this[0].innerHTML},e.prototype.text=function(e){return null!=e?this.html(_escapeHTML(e)):this.html()},e.prototype.on=function(e,n){var a,c;return c=this,(a=this.events)[e]||(a[e]=[]),this.events[e].push(n),o(this,function(n){var o,a,s;return a=(s=c.handlers)[n]||(s[n]=r(this,c.events)),o=a.handleds,-1===o.indexOf(e)?(t(this,e,a),o.push(e)):void 0}),this},e.prototype.trigger=function(e,t){return null==t&&(t={}),o(this,function(){var r,n,o;r=document.createEvent("HTMLEvents"),r.initEvent(e,!0,!0);for(n in t)o=t[n],r[n]=o;return this.dispatchEvent(r)}),this},e.prototype.remove=function(){return o(this,function(){return this.parentNode?this.parentNode.removeChild(this):void 0}),this},e.prototype.replaceWith=function(e){return"string"==typeof e&&(e=new casua.Node(e)),o(this,function(t,r){return o(e,function(e,t){return r.parentNode?r.parentNode.replaceChild(t,r):void 0})}),this},e.prototype.val=function(e){return null!=e?(o(this,function(){return this.value=e}),this):this[0].value},e}(),_scopeInitParent=function(e,t){return e._childs=[],null!=t?(-1===t._childs.indexOf(e)&&t._childs.push(e),e._parent=t):void 0},_scopeRemovePrepare=function(e,t){var r,n;return e._data[t]instanceof casua.Scope&&(n=e._data[t],null!=n._parent&&(r=n._parent._childs.indexOf(n),n._parent._childs.splice(r,1))),_scopeCallWatch(e,e._data[t],t,"$delete")},_scopeCallWatch=function(e,t,r,n){var o,a,c,s,i,_,u,h,l;if("string"==typeof n&&"$"===n.charAt(0))return _scopeCallAltWatch(e,t,r,n);if(e._watches[n])for(u=e._watches[n],c=0,i=u.length;i>c;c++)a=u[c],a.call(e,t,r,n);for(h=e._childs,l=[],s=0,_=h.length;_>s;s++)o=h[s],null==o._data[n]?l.push(_scopeCallWatch(o,t,r,n)):l.push(void 0);return l},_scopeCallAltWatch=function(e,t,r,n){var o,a,c,s,i;if(e._watches[n]){for(s=e._watches[n],i=[],a=0,c=s.length;c>a;a++)o=s[a],i.push(o.call(e,t,n,r));return i}},__mutiple_levels_key_regexp=/^([^\.]+)\.(.+)$/,casua.Scope=function(){function e(e,t){var r,n;if(e instanceof casua.Scope)return e;if(null!=e.length)return new casua.ArrayScope(e,t);_scopeInitParent(this,t),this._watches={},this._data={};for(r in e)n=e[r],this.set(r,n)}return e.prototype.get=function(e){var t,r;return this._watch_lists&&-1===this._watch_lists.indexOf(e)&&this._watch_lists.push(e),"string"==typeof e&&(t=e.match(__mutiple_levels_key_regexp))?this.get(t[1]).get(t[2]):"$parent"===e?this._parent:(r=this._data[e],null==r&&null!=this._parent&&(r=this._parent.get(e)),r)},e.prototype.set=function(e,t){var r,n;return"string"==typeof e&&(n=e.match(__mutiple_levels_key_regexp))?this.get(n[1]).set(n[2],t):"string"==typeof e&&"$"===e.charAt(0)||("object"==typeof t&&(t=new casua.Scope(t,this)),this._data[e]===t)?void 0:(r=this._data[e],this._data[e]=t,null==r&&_scopeCallWatch(this,t,e,"$add"),_scopeCallWatch(this,t,r,e))},e.prototype.remove=function(e){var t;return"string"==typeof e&&(t=e.match(__mutiple_levels_key_regexp))?this.get(t[1]).remove(t[2]):(_scopeRemovePrepare(this,e),delete this._data[e])},e.prototype.$watch=function(e,t){var r,n;return"string"==typeof e&&(r=e.match(__mutiple_levels_key_regexp))?this.get(r[1]).$watch(r[2],t):((n=this._watches)[e]||(n[e]=[]),this._watches[e].push(t))},e.prototype.$startGetWatches=function(){return this._watch_lists=[]},e.prototype.$stopGetWatches=function(){var e,t;return e=function(){var e,r,n,o;for(n=this._watch_lists,o=[],e=0,r=n.length;r>e;e++)t=n[e],o.push(t);return o}.call(this),delete this._watch_lists,e},e}(),_scopeChangeLength=function(e,t){var r,n;return n=e._data.length,r=t.call(e),_scopeCallWatch(e,e._data.length,n,"length"),r},casua.ArrayScope=function(e){function t(e,t){var r,n,o,a;if(e instanceof casua.Scope)return e;if(null==e.length)return new casua.Scope(e,t);for(_scopeInitParent(this,t),this._watches={},this._data=[],r=o=0,a=e.length;a>o;r=++o)n=e[r],this.set(r,n)}return __extends(t,e),t.prototype.length=function(){return this._data.length},t.prototype.indexOf=function(e){return this._data.indexOf(e)},t.prototype.remove=function(e){return _scopeChangeLength(this,function(){return _scopeRemovePrepare(this,e),this._data.splice(e,1)})},t.prototype.each=function(e){var t,r,n,o,a,c;for(a=this._data,c=[],t=n=0,o=a.length;o>n;t=++n)r=a[t],c.push(e.call(this,this.get(t),t));return c},t.prototype.pop=function(){return this.remove(this._data.length-1)[0]},t.prototype.shift=function(){return this.remove(0)[0]},t.prototype.push=function(){var e;return e=arguments,_scopeChangeLength(this,function(){var t,r,n;for(r=0,n=e.length;n>r;r++)t=e[r],this.set(this._data.length,t);return this._data.length})},t.prototype.unshift=function(){var e,t,r,n;return n=this._data.length,this.push.apply(this,arguments),r=function(){var r,o,a,c;for(a=this._data,c=[],e=r=0,o=a.length;o>r;e=++r)t=a[e],n>e?c.push(e+arguments.length):c.push(e-n);return c}.apply(this,arguments),_scopeCallWatch(this,r,null,"$move"),_scopeCallWatch(this,this._data.length,n,"length"),this._data.length},t.prototype.reverse=function(){var e,t,r;return this._data.reverse(),r=function(){var r,n,o,a;for(o=this._data,a=[],e=r=0,n=o.length;n>r;e=++r)t=o[e],a.push(this._data.length-1-e);return a}.call(this),_scopeCallWatch(this,r,null,"$move"),this},t.prototype.sort=function(e){var t,r,n,o,a;return o=this,a=function(){var e,n,o,a;for(o=this._data,a=[],t=e=0,n=o.length;n>e;t=++e)r=o[t],a.push({e:r,o:t});return a}.call(this),a.sort(function(t,r){return e.call(o,t.e,r.e)}),n=[],this._data=function(){var e,o,c;for(c=[],t=e=0,o=a.length;o>e;t=++e)r=a[t],n[r.o]=t,c.push(r.e);return c}(),_scopeCallWatch(this,n,null,"$move"),this},t.prototype.filter=function(e){var t,r,n,o,a,c,s,i,_,u;for(n=[],i=this._data,t=o=0,c=i.length;c>o;t=++o)r=i[t],e.call(this,r)||n.push(t);for(_=n.reverse(),u=[],a=0,s=_.length;s>a;a++)t=_[a],u.push(this.remove(t));return u},t}(casua.Scope),casua.defineController=function(init_fn){var __computeBind,__compute_controller_method_regexp,__compute_controller_regexp,__compute_match_key_regexp,__compute_match_regexp,__compute_scope_key_regexp,__compute_scope_regexp,__keep_original_attr_regexp,__nodeAttrBind,__nodeBind,__nodeCondition,__nodeValueBind,__resolveMethod,_renderNode,_renderNodes;return _renderNode=function(e,t,r,n){var o,a,c,s,i,_,u,h;if(t instanceof casua.ArrayScope)return _renderNodes(e,t,r,n);if(n["@controller"])return s=_shallowCopy(n),c=new n["@controller"](t,e),delete s["@controller"],_renderNode(c,t,r,s);h=[];for(_ in n)if(o=n[_],"@"===_.charAt(0)){if(u=_.toLowerCase().match(/^@(\w+)(?: (\S+))?$/))switch(u[1]){case"on":a=o.match(/^(\S+?)(?:\(\))?$/),r.on(u[2],__resolveMethod(e,a[1]));break;case"html":case"text":__nodeBind(e,r,u[1],t,o);break;case"val":__nodeValueBind(e,r,t,o);break;case"attr":__nodeAttrBind(e,r,u[2],t,o);break;case"class":__nodeAttrBind(e,r,u[1],t,o);break;case"child":_renderNode(e,t.get(u[2]),r,o);break;case"if":__nodeCondition(e,r,u[1],t,o)}}else i=new casua.Node(_),h.push(i),r.append(i),"object"==typeof o?_renderNode(e,t,i,o):__nodeBind(e,i,"text",t,o);return h},_renderNodes=function(e,t,r,n){var o,a;return r.empty(),a=[],o=function(t,o,c){return a[c]=_renderNode(e,t,r,n)},t.$watch("$add",o),t.$watch("$delete",function(e,t,r){var n,o,c,s,i;for(o=a.splice(r,1)[0],i=[],c=0,s=o.length;s>c;c++)n=o[c],i.push(n.remove());return i}),t.$watch("$move",function(e){var t,n,o,c,s,i,_,u,h,l;for(h=[],c=s=0,_=e.length;_>s;c=++s)t=e[c],h[t]=a[c];for(a=h,r.empty(),l=[],i=0,u=a.length;u>i;i++)o=a[i],l.push(function(){var e,t,a;for(a=[],e=0,t=o.length;t>e;e++)n=o[e],a.push(r.append(n));return a}());return l}),t.each(function(e,t){return o.call({},e,null,t)})},__nodeBind=function(e,t,r,n,o){return __computeBind(e,n,o,function(e){return t[r].call(t,e)})},__keep_original_attr_regexp=/^class$/,__nodeAttrBind=function(e,t,r,n,o){var a,c,s,i;return c=r.match(__keep_original_attr_regexp)&&(a=t.attr(r))?a+" ":void 0,__computeBind(e,n,o,function(e){return null!=c&&(e=c+e),t.attr(r,e)}),r.match(__boolean_attr_regexp)&&(s=o.match(__compute_scope_key_regexp))?(i=function(){return n.set(s[1],t.attr(r))},t.on("click",i)):void 0},__nodeValueBind=function(e,t,r,n){var o,a,c,s,i,_,u,h;if(!(c=n.match(__compute_scope_key_regexp)))return __nodeBind(e,_root,"val",r,child);for(o=function(){return t.val(r.get(c[1]))},s=function(){return r.set(c[1],t.val())},t.on("change",s),t.on("keyup",s),r.$startGetWatches(),o.call(r),u=r.$stopGetWatches(),h=[],i=0,_=u.length;_>i;i++)a=u[i],h.push(r.$watch(a,o));return h},__nodeCondition=function(e,t,r,n,o){var a,c,s;return a=s=t,c=new casua.Node("<!-- -->"),__computeBind(e,n,o,function(e){return e?(a.replaceWith(s),a=s):(a.replaceWith(c),a=c)},!0)},__compute_match_regexp=/\{\{([\S^\}]+)\}\}/g,__compute_match_key_regexp=/^\{\{([\S^\}]+)\}\}$/,__compute_scope_regexp=/@(\S+)/g,__compute_scope_key_regexp=/^@(\S+)$/,__compute_controller_regexp=/(\S+)\(\)/g,__compute_controller_method_regexp=/^(\S+)\(\)$/,__computeBind=function(_controller,_scope,src,fn,to_eval){var key,keys_to_watch,method,r,watch_fn,_i,_len,_ref,_results;for(null==to_eval&&(to_eval=!1),keys_to_watch=[],watch_fn=(r=src.match(__compute_controller_method_regexp))?(method=__resolveMethod(_controller,r[1]),function(){return fn.call({},method.call(_controller))}):(r=src.match(__compute_scope_key_regexp))?function(){return fn.call({},this.get(r[1]))}:(r=src.match(__compute_match_regexp))?function(){var e;return e=this,fn.call({},src.replace(__compute_match_regexp,function(t){return t=t.match(__compute_match_key_regexp),e.get(t[1])}))}:to_eval?(src=src.replace(__compute_controller_regexp,function(e){return e=e.match(__compute_controller_method_regexp),method=__resolveMethod(_controller,e[1]),"method.call(_controller)"}),src=src.replace(__compute_scope_regexp,function(e){return e=e.match(__compute_scope_key_regexp),'_scope.get("'+e[1]+'")'}),function(){return fn.call({},eval(src))}):function(){return fn.call({},src)},_scope.$startGetWatches(),watch_fn.call(_scope),_ref=_scope.$stopGetWatches(),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_results.push(_scope.$watch(key,watch_fn));return _results},__resolveMethod=function(e,t){var r,n;for(r=e;;){if(n=null!=r.methods?r.methods[t]:void 0,null!=n)break;if(!(r=r._parent))break}return n},function(){function e(e,t){this._parent=t,this.scope=new casua.Scope(e),this.methods=init_fn.call(this,this.scope,this,this._parent)}return e.prototype.renderAt=function(e,t){return _renderNode(this,this.scope,new casua.Node(e).empty(),t)},e.prototype.render=function(e){var t;return t=new casua.Node(document.createElement("div")),_renderNode(this,this.scope,t,e),t},e}()},window.casua=casua}).call(this);